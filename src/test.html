<html ng-app="app">
<head>
  <meta charset="utf-8">
  <script type="text/javascript" src="../bower_components/angular/angular.min.js"></script>
  <style>
    body{
      font-size:14px;
      font-family:"微软雅黑";
    }
    *{
      padding:0;
      margin:0;
    }
    .active{
      background:#fff7d6;
    }
  </style>
  <style>
    table {
      width: 100%;
      table-layout: fixed;
      border-collapse: collapse;
    }

    .tblbody tr:hover {
      background: #fff7d6;
    }

    table th,
    table td {
      height: 30px;
      line-height: 30px;
      padding: 5px;
      border: 1px solid #dfdfdf;

    }

    table th {
      color: #707070;
      background: #f2f2f2;
      text-align: center;
      font-weight: normal;
      border-bottom: 0;
      font-size:14px;
    }

    table td.rowNumber {
      text-align: center;
    }
    .icon-button{
      padding:3px 10px;
      border:1px solid transparent;
      border-radius:4px;
    }
    .icon-button i{
      display: inline-block;
      width: 15px;
      height: 15px;
      vertical-align:top;
      margin-top:1px;
      margin-right:5px;
      font-size: 1px;
    }
    .icon-button i.add{
      background: url("../../../Content/Themes/Framework/Images/buttons/addnew.png") no-repeat center center;
    }
    .icon-button i.del{
      background: url("../../../Content/Themes/Framework/Images/buttons/delete.png") no-repeat center center;
    }
    .icon-button:hover{
      border:1px solid #a0a0a0;
      background:#f5f5f5;
    }
    .ang-table input[type="text"]{
      /*width:100%;*/
      height:30px;
      line-height:30px;
      border:1px solid #ccc;
      padding:0 5px;

    }
    .ang-table select{
      height:30px;
      /*width:100%;*/
    }
    .ang-table input,.ang-table select,.ang-table label{
      font-size:12px;
    }
    .ang-table input,.ang-table select{
      display:inline-block;
      vertical-align:middle;
    }
  </style>
</head>
<body ng-controller="myController">
<div class="easyui-layout">
  <h3 style="text-align:center;margin:10px 0;">土建-抹灰工程</h3>
  <div class="ang-buttons" style="margin:10px;">
    <a class="icon-button"  ng-click="add()"><i class="add"></i>添加检验项</a>
    <a class="icon-button" ng-click="addSub()"><i class="add"></i>添加子检验项</a>
    <a class="icon-button" ng-click="remove()"><i class="del"></i>删除</a>
    <a class="icon-button" ng-click="sortUp()"><i class="sortup"></i>上移</a>
    <a class="icon-button" ng-click="sortDown()"><i class="sortdown"></i>下移</a>
    <a class="icon-button" ng-click="save()">提交</a>
    <!--@*<input type="button" value="添加检测项" ng-click="add()" />-->
    <!--<input type="button" value="添加Sub" ng-click="addSub()" />-->
    <!--<input type="button" value="Remove" ng-click="remove()" />-->
    <!--<input type="button" value="Up" ng-click="sortUp()" />-->
    <!--<input type="button" value="Down" ng-click="sortDown()" />-->
    <!--<input type="button" value="Save" ng-click="save()" />*@-->
  </div>
  <table border="0" width="100%" class="ang-table" cellspacing="0" cellpadding="0">
    <thead>
    <tr>
      <th style="width:40px;text-align:center;"></th>
      <th colspan="2">检测指标</th>
      <th>实测方式</th>
      <th>合格标准</th>
      <th>计算合格率方式</th>
      <th>合并测量</th>
      <th>图标</th>
    </tr>
    </thead>
    <tbody>
    <tr ng-repeat="n in data.rows" ng-class="{active:n.selected||(n.parent && n.parent.selected)}" ng-click="select(n)">
      <td style="width:40px;text-align:center;">{{$index+1}}</td>
      <td rowspan="{{n.rowSpan}}" colspan="{{n.colSpan}}" ng-if="n.rowSpan">
        <input type="text" ng-model="n.CategoryName" />
        <label ng-if="n.subs.length"><br /> <input type="radio" ng-model="n.cl" ng-true-value="0" ng-false-value="1" />各自测量 </label><br />
        <label ng-if="n.subs.length"> <input type="radio" ng-model="n.cl" ng-true-value="1" ng-false-value="0" />选择材质测量 </label>
      </td>
      <td ng-if="n.parent || n.colSpan==1"><input type="text" ng-model="n.ProjectName" /></td>
      <td><select ng-model="n.measureType">
        <option value="1">原位标注</option>
        <option value="1">非原位标注</option>
      </select></td>
      <td>
        <select ng-model="n.inputType">
          <option value="1">测量组对比</option>
          <option value="2">测量值</option>
          <option value="3">与设计值对比</option>
          <option value="4">区域测量对比</option>
          <option value="5">上下楼层对比</option>
        </select>
        <select ng-model="n.inputFh">
          <option>></option>
        </select>
        <input type="text"/>
        <label ng-if="n.inputType==1">默认组员数 <input type="text" ng-model="n.defaultNum" placeholder="2"/></label>
        <label ng-if="n.inputType==4">最大偏差 <input type="text" ng-model="n.maxRatio" placeholder="4"/></label>
      </td>
      <td><select ng-model="n.passType">
        <option value="1">合格点数/测量点数</option>
        <option value="1">合格组数/测量组数</option>
      </select></td>
      <td rowspan="{{n.rowSpan}}" ng-if="n.rowSpan">
        <label><input type="checkbox" ng-model="n.passratio"/>各自合格率</label>
        <label><input type="checkbox" ng-model="n.passratio"/>汇总合格率</label>
      </td>
      <td><select>
        <option>三角形</option>
      </select></td>
    </tr>
    </tbody>
  </table>
</div>
</body>
<script type="text/javascript">
  angular.module('app', [])
    .controller('myController', function ($scope) {
      var data = {
        rows: []
      };
      var newItem = function (obj) {
        obj = obj || {};
        return angular.extend({
          rowSpan: 1,
          colSpan: 2,
          subs: []
        }, obj);
      }
      var newSubItem = function (parent, obj) {
        var subItem = newItem(obj);
        subItem.rowSpan = 0;
        subItem.parent = parent;
        parent.colSpan = 1;
        parent.subs.push(subItem);
        parent.rowSpan = parent.subs.length + 1;
        return subItem
      }
      $scope.data = data;
      $scope.add = function (obj) {
        var item = newItem(obj)
        data.rows.push(item);
        return item;
      }
      $scope.addSub = function (parent,obj) {
        if (parent || data.current) {
          var sub = newSubItem(parent || data.current,obj);
          for (var i = 0, l = data.rows.length;i<l;i++){
            if (data.rows[i] == (parent || data.current)) {
              data.rows.splice(i+1, 0, sub);
              return;
            }
          }
          return sub;
        }
      }
      $scope.select = function (n) {
        data.rows.forEach(function (row) {
          row.selected = false;
        })
        n.selected = true;
        data.current = n;
      }
      $scope.remove = function () {
        if (data.current) {
          var item = data.current;
          if (item.parent) {
            var idx = item.parent.subs.indexOf(item);
            item.parent.subs.splice(idx, 1);
            idx = data.rows.indexOf(item);
            data.rows.splice(idx, 1);
            item.parent.rowSpan--;
            item.parent = null;
          }
          else {
            item.subs.forEach(function (sub) {
              var idx = data.rows.indexOf(sub);
              data.rows.splice(idx, 1);
              sub.parent = null;
            });
            item.subs.length = 0;
            var idx = data.rows.indexOf(item);
            data.rows.splice(idx, 1);
          }
        }
      }

      $scope.sortUp = function () {
        var n =data.current;
        if (data.current){
          var idx = data.rows.indexOf(n);
          if (idx == 0) {
            return;
          }
          var prevIndex=idx-1;
          var prev = data.rows[prevIndex];
          if (n.parent) {
            if (!prev.parent) {

              n.subs = prev.subs;
              n.subs.push(prev);
              n.CategoryName = prev.CategoryName;
              n.parent = null;
              var nx = n.subs.indexOf(n);
              n.subs.splice(nx, 1);
              n.subs.forEach(function (it) {
                it.parent = n;
              });
              prev.rowSpan = 0;
              n.rowSpan = n.subs.length + 1;
              n.colSpan = 1;
            }
            data.rows[idx - 1] = n;
            data.rows[idx] = prev;
            //$scope.$apply();
            //}
          }
          else {
            while (prev.parent) {
              prev = data.rows[--prevIndex];
            }
            data.rows[prevIndex] = n;
            for (var i = 0, l = n.subs.length; i < l; i++) {
              data.rows[++prevIndex] = n.subs[i];
            }
            data.rows[++prevIndex] = prev;
            prev.subs.forEach(function (it) {
              data.rows[++prevIndex] = it;
            })
          }
          //var insertIndex = idx - prev.rowSpan-1;

        }
      }
    $scope.sortDown = function(){
      var n =data.current;
      if (data.current){
        var idx = data.rows.indexOf(n);
        if (idx == idx-1) {
          return;
        }
        var prevIndex=idx-1;
        var prev = data.rows[prevIndex];
//        if (n.parent) {
//          if (!prev.parent) {
//
//            n.subs = prev.subs;
//            n.subs.push(prev);
//            n.CategoryName = prev.CategoryName;
//            n.parent = null;
//            var nx = n.subs.indexOf(n);
//            n.subs.splice(nx, 1);
//            n.subs.forEach(function (it) {
//              it.parent = n;
//            });
//            prev.rowSpan = 0;
//            n.rowSpan = n.subs.length + 1;
//            n.colSpan = 1;
//          }
//          data.rows[idx + 1] = n;
//          data.rows[idx] = prev;
//          //$scope.$apply();
//          //}
//        }
//        else {
          while (prev.parent) {
            prev = data.rows[++prevIndex];
          }
          data.rows[prevIndex] = n;
          for (var i = 0, l = n.subs.length; i < l; i++) {
            data.rows[--prevIndex] = n.subs[i];
          }
          data.rows[--prevIndex] = prev;
          prev.subs.forEach(function (it) {
            data.rows[--prevIndex] = it;
          })
       // }
        //var insertIndex = idx - prev.rowSpan-1;

      }

    }
      $scope.save = function () {
        data.rows.forEach(function (row) {
          if (row.parent) {
            row.CategoryName = row.parent.CategoryName;
          }
        })
        console.log('data', data.rows);
      }
      var result = {
        rows: [
          { ProjectName: '方正度', CategoryName: '方正度' },
          { ProjectName: '高度', CategoryName: '门洞' },
          { ProjectName: '宽度', CategoryName: '门洞' }
        ]
      };

      var prev;
      result.rows.forEach(function (row) {

        if (prev && prev.CategoryName == row.CategoryName) {
          $scope.addSub(prev, row);
        }
        else {
          prev = $scope.add(row);
        }
      })


    })
</script>
</html>
